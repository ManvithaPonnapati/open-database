import tensorflow as tf123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFdef _dense_kernel_sparse_matmul_from_point_pairs(point_pairs,rel_coords,s_features,d_features,kernel,pixel_size):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    # todo(could be arbitrary dimensionality convolution)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    k_dims = tf.shape(kernel)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    conv_dims = tf.shape(kernel)[0:3]123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    k_size = tf.cast(tf.shape(kernel)[0:3], tf.float32)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    # gather and concatenate features pairs123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    s_features = tf.gather(s_features,point_pairs[:,0],validate_indices=True)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    d_features = tf.gather(d_features,point_pairs[:,1],validate_indices=True)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    sd_features = tf.concat([s_features,d_features],axis=1)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    # flatten kernel from 5D into 3D123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    k_flatshape = tf.concat([[tf.reduce_prod(k_dims[0:3])],k_dims[3:5]],0)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    k_flat = tf.reshape(kernel,k_flatshape)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    # find indices on the flattened kernel to gather/slice123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    k_gatheridx = tf.cast((rel_coords / pixel_size) + (k_size/2) + 0.5,tf.int32)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    k_gatheridx = tf.reduce_sum(k_gatheridx * tf.stack([conv_dims[0] * conv_dims[1], conv_dims[1], 1]),1)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    # gather slices of the kernels123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    k_shards = tf.gather(k_flat,k_gatheridx)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    convout = tf.matmul(tf.expand_dims(sd_features,1),k_shards)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    convout = tf.squeeze(convout)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    return convout123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF