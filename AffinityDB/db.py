import os123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFimport sys123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFimport sqlite3123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFimport config123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFimport time123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFfrom config import lock123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFfrom utils import lockit123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNFclass database:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def __init__(self):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.db_path = config.db_path123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.connect_db()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def connect_db(self):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.conn = sqlite3.connect(self.db_path)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.connect = True123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def backup_db(self):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        backup_db_path = self.db_path.replace('.', '_'+time.strftime("%Y-%m-%d-%H:%M:%S", time.gmtime()) +'.')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        if os.path.exists(self.db_path):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            cmd = 'cp %s %s' % (self.db_path , backup_db_path)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            os.system(cmd)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            print "backup database %s" % backup_db_path123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def backup_and_reset_db(self):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        if os.path.exists(self.db_path):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.backup_db()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            cmd = 'rm %s' % self.db_path123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            os.system(cmd)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.connect_db()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.create_tabel()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    @lockit123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def insert(self, tabel, values, head=None):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        sql_values = [ '(' + ','.join(value) + ')' for value in values ]123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt = 'INSERT INTO ' + tabel + ' '123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        if not head is None:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            stmt += (','.join(head))123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ' VALUES '123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ','.join(sql_values)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ';'123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        if not self.connect:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.connect_db()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        try:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.conn.execute(stmt)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        except sqlite3.IntegrityError as e:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            print "Integrity Error ",123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            print e123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        except Exception as e:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            print e123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.conn.commit()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    @lockit123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def insert_or_replace(self, tabel, values, head=None):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        db_value = lambda x:'"%s"' % x if type(x).__name__ == 'str' else str(x)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        db_values = [ map(db_value, value) for value in values ]123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        print db_values123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        sql_values = [ '(' + ','.join(value) + ')' for value in db_values ]123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        print sql_values123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt = 'REPLACE INTO ' + tabel + ' '123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        if not head is None:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            stmt += '('+ ','.join(head) + ')'123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ' VALUES '123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ','.join(sql_values)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ';'123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        #print stmt123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        if not self.connect:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.connect_db()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        try:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.conn.execute(stmt)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        except Exception as e:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            print e123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.conn.commit()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    @lockit123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def insert_or_ignore(self, tabel, values, head):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        sql_values = [ '(' + ','.join(value) + ')' for value in values ]123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt = 'INSERT OR IGNORE INTO ' + tabel + ' '123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += (','.join(head))123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ' VALUES '123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ','.join(sql_values)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt += ';'123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        if not self.connect:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.connect_db()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        try:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.conn.execute(stmt)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        except Exception as e:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            print e123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        self.conn.commit()123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF    def create_tabel(self):123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        """123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        create the tabels that we gonna use123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        """123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt = []123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # atom num tabel123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE ATOM_NUM123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (NAME       TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        TYPE        TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        ATOM_NUM    INTEGER,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(NAME)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # rotable bond123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE ROTABLE_BOND123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (LIGAND         TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        ROTABLE_BOND    INTEGER,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(LIGAND)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append('''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE RESOLUTION123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (PDB        TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        RESOLUTION  REAL NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(PDB)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # parse stat123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE SPLIT_STATE123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (PDB        TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        STATE       INTEGER,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        COMMENT     TEXT,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(PDB)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # tanimoto similarity123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE SIMILARITY123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (LIGAND_A       TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        LIGAND_B        TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        FINGER_PRINT    TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        SIMILARITY      READ NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(LIGAND_A, LIGAND_B)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # overlap123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE OVERLAP123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (DOCKED_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CRYSTAL_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        POSITION            INTEGER NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        OVERLAP_RATIO       READ NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(DOCKED_LIGAND, CRYSTAL_LIGAND, POSITION)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # overlap state123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE OVERLAP_STATE123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (DOCKED_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        STATE               INTEGER NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(DOCKED_LIGAND)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # rmsd 123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE RMSD123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (DOCKED_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CRYSTAL_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        POSITION             INTEGER NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        RMSD                READ NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(DOCKED_LIGAND, CRYSTAL_LIGAND, POSITION)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE RMSD_STATE123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (DOCKED_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CRYSTAL_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        STATE               INTEGER NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(DOCKED_LIGAND, CRYSTAL_LIGAND)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        # native contace 123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        stmt.append( '''123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        CREATE TABLE NATIVE_CONTACE123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        (DOCKED_LIGAND      TEXT NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        POSITION            INTEGER  NOT NULL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        RATIO_4_0           REAL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        RATIO_4_5           REAL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        RATIO_5_0           REAL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        RATIO_5_5           REAL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        RATIO_6_0           REAL,123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        PRIMARY KEY(DOCKED_LIGAND,POSITION)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        );''')123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        for s in stmt:123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF            self.conn.execute(s)123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF123343DJNBFHJBJNKFJNBHDRFBNJKDJUNF        print "create all %d tabels" % len(stmt)